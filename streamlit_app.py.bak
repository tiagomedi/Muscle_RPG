#!/usr/bin/env python3
"""P√°gina principal de Muscle RPG con sistema de login."""
import streamlit as st
from src.database.db_manager import DatabaseManager


st.set_page_config(
    page_title="Muscle RPG",
    page_icon="üí™",
    layout="centered",
    initial_sidebar_state="auto",
)

def init_session_state():
    """Inicializa variables de sesi√≥n."""
    if 'logged_in' not in st.session_state:
        st.session_state['logged_in'] = False
    if 'username' not in st.session_state:
        st.session_state['username'] = None

def main():
    st.title("Muscle RPG")
    st.caption("Tu entrenador personal gamificado")
    
    init_session_state()
    db = DatabaseManager()
    
    if st.session_state['logged_in']:
        st.success(f"Bienvenido, {st.session_state['username']}!")
        st.markdown("""
        üëà Usa el men√∫ lateral para navegar entre secciones:
        
        - **Perfil**: Configura tu nivel y genera tu rutina
        - **Seguimiento**: Registra tu progreso diario
        """)
        
        if st.button("Cerrar sesi√≥n"):
            st.session_state['logged_in'] = False
            st.session_state['username'] = None
            st.experimental_rerun()
        return

    tab1, tab2 = st.tabs(["Iniciar sesi√≥n", "Registrarse"])
    
    with tab1:
        with st.form("login_form"):
            username = st.text_input("Usuario")
            password = st.text_input("Contrase√±a", type="password")
            submit = st.form_submit_button("Iniciar sesi√≥n")
            
            if submit:
                if db.validate_login(username, password):
                    st.session_state['logged_in'] = True
                    st.session_state['username'] = username
                    st.success("¬°Inicio de sesi√≥n exitoso!")
                    st.experimental_rerun()
                else:
                    st.error("Usuario o contrase√±a incorrectos")
    
    with tab2:
        with st.form("register_form"):
            new_username = st.text_input("Usuario nuevo")
            new_password = st.text_input("Contrase√±a nueva", type="password")
            confirm_password = st.text_input("Confirmar contrase√±a", type="password")
            submit = st.form_submit_button("Registrarse")
            
            if submit:
                if not new_username or not new_password:
                    st.error("Por favor completa todos los campos")
                elif new_password != confirm_password:
                    st.error("Las contrase√±as no coinciden")
                else:
                    if db.register_user(new_username, new_password):
                        st.success("¬°Registro exitoso! Ahora puedes iniciar sesi√≥n")
                    else:
                        st.error("El usuario ya existe")

    st.markdown("---")
    st.markdown(
    """
    **Resumen del proyecto**

    La planificaci√≥n de rutinas de entrenamiento suele ser gen√©rica y poco adaptable al progreso
    individual del usuario, lo que limita la eficiencia de los resultados. Este proyecto propone
    modelar los ejercicios de hipertrofia muscular y su progresi√≥n mediante un grafo que representa
    posibles caminos de entrenamiento, permitiendo identificar rutas que maximicen las ganancias
    musculares de forma progresiva y estructurada.

    A diferencia de otros enfoques que abarcan m√∫ltiples objetivos (fuerza, resistencia o potencia),
    este trabajo se centrar√° exclusivamente en la hipertrofia, es decir, el aumento del tama√±o del
    m√∫sculo a trav√©s de una planificaci√≥n inteligente del volumen, la intensidad y la frecuencia de
    entrenamiento.

    El modelo propuesto busca integrar la planificaci√≥n de ejercicios en un entorno gamificado,
    donde el usuario ‚Äúsube de nivel‚Äù al completar ciclos de entrenamiento trimestrales (cada 3 meses),
    momento en que el sistema eval√∫a su progreso, ajusta la rutina y aumenta gradualmente la
    dificultad. Cada sesi√≥n de entrenamiento tendr√° una duraci√≥n constante de 2 horas diarias,
    par√°metro fijo que facilita el modelamiento y la comparaci√≥n entre ciclos. De esta forma, el
    sistema puede estructurar rutinas trimestrales personalizadas, maximizando el crecimiento muscular
    y garantizando la adherencia del usuario mediante retroalimentaci√≥n continua y una sensaci√≥n de
    progreso similar a la de un videojuego RPG.
    """
)

with st.sidebar:
    st.header("Par√°metros")
    days = st.selectbox("D√≠as por semana", [3, 4, 5], index=1)
    # Tiempo por sesi√≥n fijo: 2 horas (120 minutos) seg√∫n especificaci√≥n
    time_per_session = 120
    st.markdown("**Tiempo por sesi√≥n:** 120 minutos (fijo)")
    # Usar session_state para que podamos aplicar recomendaciones desde el cuestionario
    if 'user_level_slider' not in st.session_state:
        st.session_state['user_level_slider'] = 0
    level = st.slider("Nivel del usuario", min_value=0, max_value=1, value=st.session_state['user_level_slider'], key='user_level_slider', help="0 = B√°sico, 1 = Intermedio")
    # Bot√≥n para abrir cuestionario que estima el nivel
    if st.button("¬øCu√°l es mi nivel? / No s√© mi nivel"):
        st.session_state['show_level_quiz'] = True
    show_instructions = st.checkbox("Mostrar instrucciones de los ejercicios", value=True)
    generate = st.button("Generar rutina")


def find_exercise_by_id(exercises, ex_id):
    for e in exercises:
        if e.get("exerciseId") == ex_id:
            return e
    return None


if generate:
    with st.spinner("Generando rutina..."):
        # Generar rutina usando la l√≥gica existente
        routine = routine_builder.generate_routine(days, time_per_session=time_per_session, user_level=level)
        exercises = routine_builder.load_exercises()

    st.success("Rutina generada")

    # Mostrar resumen
    col1, col2 = st.columns([2, 1])
    with col1:
        st.subheader("Plan semanal")
        schedule = routine.get("schedule", {})
        for day_key in sorted(k for k in schedule.keys() if not k.endswith("_meta")):
            meta = schedule.get(day_key + "_meta", {})
            st.markdown(f"### {day_key.replace('_', ' ').title()} ‚Äî Tiempo total: {meta.get('total_time_min', 0)} min")
            items = schedule.get(day_key, [])
            if not items:
                st.write("(Sin ejercicios para este d√≠a)")
            for ex in items:
                ex_raw = find_exercise_by_id(exercises, ex.get("id"))
                cols = st.columns([1, 4])
                with cols[0]:
                    if ex_raw and ex_raw.get("gifUrl"):
                        st.image(ex_raw.get("gifUrl"), use_column_width=True)
                    else:
                        st.write("")
                with cols[1]:
                    st.markdown(f"**{ex.get('name')}** ‚Äî {ex.get('sets')}x{ex.get('reps')} reps ‚Äî {ex.get('time_min')} min")
                    st.markdown(f"_M√∫sculos:_ {', '.join(ex.get('muscles', []))}")
                    if show_instructions and ex_raw:
                        instr = ex_raw.get("instructions") or []
                        if instr:
                            st.markdown("**Instrucciones:**")
                            for step in instr:
                                st.write(step)
                    st.write("---")

    with col2:
        st.subheader("Resumen semanal")
        done = routine.get("weekly_sets_done", {})
        target = routine.get("weekly_target_per_muscle", 0)
        st.write("Sets por m√∫sculo (hecho / objetivo):")
        for m, v in done.items():
            st.write(f"- {m}: {v}/{target}")

        st.write("")
        st.subheader("Estamina")
        limits = routine.get("stamina_limit_per_muscle", {})
        used = routine.get("stamina_used", {})
        rem = routine.get("stamina_remaining", {})
        for m in sorted(limits.keys()):
            st.write(f"- {m}: usado {used.get(m,0)} / l√≠mite {limits.get(m,0)} (rem: {rem.get(m,0)})")

        st.write("")
        st.subheader("Exportar")
        json_bytes = json.dumps(routine, ensure_ascii=False, indent=2).encode("utf-8")
        st.download_button(label="Descargar rutina (JSON)", data=json_bytes, file_name="routine.json", mime="application/json")

    st.sidebar.markdown("---")
    st.sidebar.caption("Prototipo: usa la l√≥gica en `src/routine_builder.py`")

else:
    st.info("Configura par√°metros a la izquierda y pulsa 'Generar rutina' para crear un prototipo interactivo.")

# Mostrar cuestionario para estimar nivel si el usuario lo solicit√≥
if st.session_state.get('show_level_quiz', False):
    st.markdown("### Cuestionario t√©cnico y de perfil para estimar tu nivel")
    with st.form("level_quiz"):
        # Perfil general (constantes y variables)
        age = st.number_input("Edad (a√±os)", min_value=13, max_value=100, value=25, step=1)
        gender = st.selectbox("G√©nero (opcional)", ["No declarar", "Femenino", "Masculino", "Otro"], index=0)
        height_cm = st.number_input("Estatura (cm)", min_value=100, max_value=230, value=175, step=1)
        weight_kg = st.number_input("Peso actual (kg)", min_value=30.0, max_value=300.0, value=75.0, step=0.5)
        environment = st.selectbox("Entorno de entrenamiento", ["Gimnasio", "En casa", "H√≠brido"], index=2)
        # Variables de entrenamiento
        years = st.number_input("¬øCu√°nto tiempo llevas entrenando consistentemente? (a√±os)", min_value=0.0, max_value=50.0, value=1.0, step=0.5)
        sessions = st.selectbox("Sesiones por semana (rango)", ["1-2", "2-3", "3-4", "4-5", "5-6", "6-7"], index=3)
        submitted = st.form_submit_button("Calcular nivel recomendado")

    if submitted:
        # Construir perfil y guardarlo
        user_profile = {
            'age': age,
            'gender': gender,
            'height_cm': height_cm,
            'weight_kg': weight_kg,
            'environment': environment,
            'years': years,
            'sessions_per_week': sessions,
        }
        st.session_state['user_profile'] = user_profile

        # Scoring heur√≠stico simplificado (max total aproximado = 8)
        # a√±os (0..3)
        if years < 0.5:
            years_score = 0
        elif years < 1.5:
            years_score = 1
        elif years < 3:
            years_score = 2
        else:
            years_score = 3
        # sesiones por rango -> mapear a 0..4
        sessions_map = {'1-2': 0, '2-3': 1, '3-4': 2, '4-5': 3, '5-6': 4, '6-7': 4}
        sess_score = sessions_map.get(sessions, 2)
        env_score = 1 if environment == 'Gimnasio' else 0

        total = years_score + sess_score + env_score
        # m√°ximo teorico aproximado = 8
        max_possible = 8
        normalized = max(0, min(total, max_possible))
        # Si tiene m√°s de la mitad del puntaje m√°ximo, se considera intermedio
        recommended = 1 if normalized > (max_possible / 2) else 0
        st.session_state['recommended_level'] = recommended
        label = {0: 'B√°sico', 1: 'Intermedio'}[recommended]
        st.success(f"Nivel recomendado: {recommended} ({label})")
        with st.expander("Ver desglose de puntuaci√≥n y perfil registrado"):
            st.write({'user_profile': user_profile, 'scores': {
                'years_score': years_score,
                'sessions_score': sess_score,
                'environment_score': env_score,
                'total_raw': total,
                'recommended_level': recommended,
            }})
        if st.button("Aplicar nivel recomendado"):
            st.session_state['user_level_slider'] = recommended
            st.session_state['show_level_quiz'] = False
            st.experimental_rerun()
